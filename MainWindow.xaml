<Window x:Class="AGVDesktop.MainWindow"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:fluent="clr-namespace:SourceChord.FluentWPF;assembly=FluentWPF"
                xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
                Title="IAOSB NUMTAL" Height="680" Width="1100"
                WindowStyle="None" ResizeMode="CanResize" Background="{StaticResource WindowBackgroundBrush}">

    <fluent:AcrylicPanel SnapsToDevicePixels="True" TintColor="{StaticResource AccentColor}" TintOpacity="0.06">
        <Border CornerRadius="14" Background="{StaticResource WindowBackgroundBrush}" Padding="10">
            <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="44" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Title bar -->
            <Grid Grid.Row="0" Background="Transparent">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel x:Name="TitleArea" Orientation="Horizontal" VerticalAlignment="Center" Margin="8,0">
                    <StackPanel.RenderTransform>
                        <TranslateTransform Y="-6" />
                    </StackPanel.RenderTransform>
                    <StackPanel.Effect>
                        <BlurEffect Radius="0" />
                    </StackPanel.Effect>
                    <StackPanel.Triggers>
                        <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                            <BeginStoryboard Storyboard="{StaticResource TitlebarEntrance}" />
                        </EventTrigger>
                        <EventTrigger RoutedEvent="MouseEnter">
                            <BeginStoryboard Storyboard="{StaticResource TitlebarHoverIn}" />
                        </EventTrigger>
                        <EventTrigger RoutedEvent="MouseLeave">
                            <BeginStoryboard Storyboard="{StaticResource TitlebarHoverOut}" />
                        </EventTrigger>
                    </StackPanel.Triggers>
                    <TextBlock Text="AGV Desktop" FontFamily="{StaticResource AppFont}" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center" />
                    <TextBlock Text="  •  IAOSB NUMTAL" Foreground="{StaticResource MutedTextBrush}" Margin="8,0,0,0" VerticalAlignment="Center" />
                    <TextBlock Text="  │  " Foreground="{StaticResource MutedTextBrush}" Margin="8,0,0,0" VerticalAlignment="Center" />
                    <TextBlock Text="{Binding BackdropStatus}" Foreground="{StaticResource MutedTextBrush}" Margin="4,0,0,0" VerticalAlignment="Center" FontSize="12" />
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,8,0">
                    <Button Margin="4,0" Click="Minimize_Click" ToolTip="Minimize" Style="{StaticResource TitlebarButtonStyle}">
                        <iconPacks:PackIconMaterial Kind="WindowMinimize" Width="14" Height="14" />
                    </Button>
                    <Button Margin="4,0" Click="MaximizeRestore_Click" ToolTip="Maximize/Restore" Style="{StaticResource TitlebarButtonStyle}">
                        <iconPacks:PackIconMaterial Kind="WindowMaximize" Width="14" Height="14" />
                    </Button>
                    <Button Width="36" Height="28" Margin="4,0" Click="Close_Click" ToolTip="Close" Background="#FFEA4335" Foreground="White" BorderThickness="0">
                        <iconPacks:PackIconMaterial Kind="Close" Width="12" Height="12" Foreground="White" />
                    </Button>
                </StackPanel>

                <!-- Drag area (only left column) -->
                <Rectangle Grid.Column="0" Fill="Transparent" MouseLeftButtonDown="TitleBar_MouseLeftButtonDown" />
            </Grid>

            <!-- Content -->
            <Grid Grid.Row="1" Margin="6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="320" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <!-- subtle overlay to strengthen acrylic/mica look -->
                <Rectangle Grid.RowSpan="2" Grid.ColumnSpan="2" Fill="{StaticResource AccentBrush}" Opacity="0.02" IsHitTestVisible="False" />

                <!-- Left panel (card) -->
                <Border Grid.Column="0" Background="{StaticResource SurfaceBrush}" CornerRadius="10" Padding="14" Effect="{StaticResource CardShadow}">
                    <StackPanel RenderTransformOrigin="0.5,0.0">
                        <StackPanel.RenderTransform>
                            <TranslateTransform Y="0" />
                        </StackPanel.RenderTransform>
                        <StackPanel.Triggers>
                            <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                                <BeginStoryboard Storyboard="{StaticResource ContentEntrance}" />
                            </EventTrigger>
                        </StackPanel.Triggers>
                        <TextBlock Text="Serial Port" FontWeight="Bold" FontFamily="{StaticResource AppFont}" />
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,8">
                            <ComboBox Width="160" ItemsSource="{Binding AvailablePorts}" SelectedItem="{Binding SelectedPort}" />
                            <TextBox Width="80" Margin="8,0,0,0" Text="{Binding BaudRate}" />
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0,8,0,8">
                                    <Button Width="150" Command="{Binding ConnectCommand}" Style="{StaticResource PrimaryButton}">
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="Usb" Width="16" Height="16" Margin="0,0,8,0" />
                                            <TextBlock Text="Connect" />
                                        </StackPanel>
                                    </Button>
                                    <Button Width="150" Margin="8,0,0,0" Command="{Binding DisconnectCommand}" Style="{StaticResource SecondaryButton}">
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="Link" Width="16" Height="16" Margin="0,0,8,0" />
                                            <TextBlock Text="Disconnect" />
                                        </StackPanel>
                                    </Button>
                        </StackPanel>

                        <Separator Margin="0,8" />

                        <TextBlock Text="Controls" FontWeight="Bold" />
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,8">
                            <Button Content="Start" Width="150" Command="{Binding StartCommand}" Style="{StaticResource PrimaryButton}" />
                            <Button Content="Stop" Width="150" Margin="8,0,0,0" Command="{Binding StopCommand}" Style="{StaticResource SecondaryButton}" />
                        </StackPanel>

                        <TextBlock Text="Send Command" FontWeight="Bold" Margin="0,8,0,0" />
                        <StackPanel Orientation="Horizontal" Margin="0,8,0,8">
                            <TextBox Width="200" Text="{Binding OutgoingCommand,UpdateSourceTrigger=PropertyChanged}" />
                            <Button Width="80" Margin="8,0,0,0" Command="{Binding SendCommandCommand}" Style="{StaticResource PrimaryButton}">
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="Send" Width="14" Height="14" Margin="0,0,6,0" />
                                            <TextBlock Text="Send" />
                                        </StackPanel>
                                    </Button>
                        </StackPanel>

                        <Separator Margin="0,8" />

                        <TextBlock Text="Status" FontWeight="Bold" />
                        <TextBlock Text="{Binding StatusMessage}" TextWrapping="Wrap" Margin="0,6,0,0" Foreground="{StaticResource MutedTextBrush}" />

                        <CheckBox Content="Minimize to tray" IsChecked="{Binding MinimizeToTray, Mode=TwoWay}" Margin="0,8,0,0" />
                        <StackPanel Orientation="Vertical" Margin="0,6,0,0">
                            <CheckBox Content="Use system Mica if available" IsChecked="{Binding UseSystemMica, Mode=TwoWay}" Margin="0,4,0,0" Checked="SystemMica_Checked" Unchecked="SystemMica_Checked" />
                            <CheckBox Content="Force Acrylic (ignore system Mica)" IsChecked="{Binding ForceAcrylic, Mode=TwoWay}" Margin="0,4,0,0" Checked="ForceAcrylic_Checked" Unchecked="ForceAcrylic_Checked" />
                        </StackPanel>
                        <!-- Diagnostics -->
                        <Border Background="Transparent" BorderBrush="{StaticResource SubtleBorderBrush}" BorderThickness="1" CornerRadius="6" Padding="8" Margin="0,10,0,0">
                            <StackPanel>
                                <TextBlock Text="Diagnostics" FontWeight="Bold" />
                                <TextBlock Text="OS:" Foreground="{StaticResource MutedTextBrush}" FontSize="12" TextWrapping="Wrap" />
                                <TextBlock Text="{Binding OSVersionInfo}" FontSize="12" Margin="0,2,0,0" />
                                <TextBlock Text="Backdrop result (HRESULT):" Foreground="{StaticResource MutedTextBrush}" FontSize="12" Margin="0,6,0,0" />
                                <TextBlock Text="{Binding MicaHr}" FontSize="12" />
                                <TextBlock Text="Settings:" Foreground="{StaticResource MutedTextBrush}" FontSize="12" Margin="0,6,0,0" />
                                <TextBlock Text="{Binding SettingsPath}" FontSize="12" TextTrimming="CharacterEllipsis" />
                                <TextBlock Text="Log:" Foreground="{StaticResource MutedTextBrush}" FontSize="12" Margin="0,6,0,0" />
                                        <TextBlock Text="{Binding LogPath}" FontSize="12" TextTrimming="CharacterEllipsis" />
                                        <TextBlock Text="Reflection attempts:" Foreground="{StaticResource MutedTextBrush}" FontSize="12" Margin="0,6,0,0" />
                                        <ScrollViewer Height="80" VerticalScrollBarVisibility="Auto">
                                            <TextBlock FontSize="11" TextWrapping="Wrap" Text="{Binding ReflectionTrace}" />
                                        </ScrollViewer>
                            </StackPanel>
                        </Border>

                        <TextBlock Text="Memory Bank" FontWeight="Bold" Margin="0,12,0,0" />
                        <ScrollViewer Height="120" VerticalScrollBarVisibility="Auto">
                            <TextBlock Text="{Binding MemoryBankText}" TextWrapping="Wrap" />
                        </ScrollViewer>
                    </StackPanel>
                </Border>

                <!-- Right content -->
                <!-- Right content -->
                <Border Grid.Column="1" Background="Transparent" Padding="10">
                    <StackPanel RenderTransformOrigin="0.5,0.0">
                        <StackPanel.RenderTransform>
                            <TranslateTransform Y="0" />
                        </StackPanel.RenderTransform>
                        <StackPanel.Triggers>
                            <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                                <BeginStoryboard Storyboard="{StaticResource ContentEntrance}" />
                            </EventTrigger>
                        </StackPanel.Triggers>
                        <TabControl>
                        <TabItem Header="Telemetry">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*" />
                                    <RowDefinition Height="200" />
                                </Grid.RowDefinitions>

                                <DataGrid ItemsSource="{Binding TelemetryItems}" AutoGenerateColumns="False" IsReadOnly="True">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Time" Binding="{Binding Timestamp}" Width="150" />
                                        <DataGridTextColumn Header="X" Binding="{Binding X}" />
                                        <DataGridTextColumn Header="Y" Binding="{Binding Y}" />
                                        <DataGridTextColumn Header="Speed" Binding="{Binding Speed}" />
                                        <DataGridTextColumn Header="Battery" Binding="{Binding Battery}" />
                                        <DataGridTextColumn Header="Raw" Binding="{Binding Raw}" Width="*" />
                                    </DataGrid.Columns>
                                </DataGrid>

                                <StackPanel Grid.Row="1">
                                    <TextBlock Text="Logs" FontWeight="Bold" />
                                    <ListBox ItemsSource="{Binding Logs}" Height="160" />
                                </StackPanel>
                            </Grid>
                        </TabItem>

                        <TabItem Header="Memory Bank">
                            <ScrollViewer>
                                <TextBlock Text="{Binding MemoryBankText}" TextWrapping="Wrap" Margin="8" />
                            </ScrollViewer>
                        </TabItem>
                        </TabControl>
                    </StackPanel>
                </Border>
            </Grid>
            </Grid>
        </Border>
    </fluent:AcrylicPanel>
</Window>
